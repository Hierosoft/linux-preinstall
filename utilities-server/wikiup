#!/usr/bin/env python3
"""wikiup - Upgrade MediaWiki by moving images and LocalSettings.php.

This script migrates a MediaWiki installation from one version to another by
moving user-uploaded images, copying LocalSettings.php, copying missing
extensions and skins, and updating the public symlink (public_html or $WWW_DIR).

Usage:
    wikiup <src> <dst> [--dry-run]

When --dry-run is used, the script outputs a bash-compatible script to stdout.
Otherwise, it performs the actions and prints progress to stderr via logger.
"""

import argparse
import logging
import os
import shutil
import sys
from pathlib import Path


class WikiUpError(RuntimeError):
    """Raised for expected operational failures during upgrade.

    Attributes:
        exit_code: Exit code to return to the shell.
    """

    def __init__(self, message, exit_code=1):
        """Initialize with message and exit code."""
        super().__init__(message)
        self.exit_code = exit_code


def get_logger():
    """Return a logger named after the script filename.

    Returns:
        logging.Logger: Configured logger instance.
    """
    script_name = os.path.basename(sys.argv[0])
    name = os.path.splitext(script_name)[0]
    return logging.getLogger(name)


def _q(path):
    """Return shell-quoted path."""
    return f'"{path}"'


def _print_undo(undo_commands):
    """Print undo commands as comments and commands."""
    print("# undo partial upgrade:")
    for cmd in undo_commands:
        print(cmd)


def _handle_component(src_dir, dst_dir, name, dry_run, out, logger, undo_list):
    """Handle copying missing extensions or skins.

    Args:
        src_dir: Source directory (e.g. src/extensions).
        dst_dir: Destination directory (e.g. dst/extensions).
        name: Component name ("extensions" or "skins").
        dry_run: Whether to simulate.
        out: Output stream (for dry-run).
        logger: Logger instance.
        undo_list: List to append undo commands.

    Returns:
        Tuple of (total_count, new_count).
    """
    total_count = 0
    new_count = 0

    if not src_dir.exists():
        logger.warning("No %s", src_dir)
        return total_count, new_count

    if not dst_dir.exists():
        cmd = f"mkdir -p {_q(dst_dir)}"
        undo = f"rmdir {_q(dst_dir)} 2>/dev/null || true"
        if dry_run:
            print(cmd, file=out)
        else:
            logger.info("Creating %s directory: %s", name, dst_dir)
            dst_dir.mkdir(parents=True, exist_ok=True)
            undo_list.append(undo)

    for item in src_dir.iterdir():
        if item.is_dir():
            total_count += 1
            dst_sub = dst_dir / item.name
            if not dst_sub.exists():
                cmd = f"rsync -a {_q(item)}/ {_q(dst_sub)}/"
                undo = f"rm -rf {_q(dst_sub)}"
                if dry_run:
                    print(cmd, file=out)
                    new_count += 1
                else:
                    try:
                        logger.info("Copying %s: %s", name[:-1], item.name)
                        shutil.copytree(str(item), str(dst_sub))
                        new_count += 1
                        undo_list.append(undo)
                    except Exception as e:
                        logger.error(
                            "Failed to copy %s %s: %s", name[:-1], item.name, e
                        )

    return total_count, new_count


def perform_wiki_upgrade(src, dst, www_dir, dry_run=False):
    """Perform the MediaWiki upgrade from src to dst.

    Args:
        src: Path to current MediaWiki installation.
        dst: Path to new MediaWiki installation.
        www_dir: Path to public symlink (public_html or $WWW_DIR).
        dry_run: If True, output bash script instead of modifying filesystem.

    Raises:
        WikiUpError: On validation or operational failure.
    """
    logger = get_logger()
    out = sys.stdout if dry_run else None
    undo_commands = []

    def log(msg):
        """Log to stderr or stdout with # prefix in dry-run."""
        if dry_run:
            print(f"# {msg}", file=out)
        else:
            logger.info("%s", msg)

    # Validate source and destination
    if not src.is_dir():
        logger.error("Source directory does not exist or is not a directory: %s", src)
        _print_undo([])
        raise WikiUpError("Invalid source directory", 1)
    if not dst.is_dir():
        logger.error("Destination directory does not exist or is not a directory: %s", dst)
        _print_undo([])
        raise WikiUpError("Invalid destination directory", 1)

    # Validate WWW_DIR symlink
    if www_dir.exists() and not www_dir.is_symlink():
        logger.error(
            "%s exists but is not a symlink. This script assumes it is "
            "the symlink to the latest version. Set WWW_DIR to a different "
            "path or remove/rename the existing %s.", www_dir, www_dir
        )
        _print_undo([])
        raise WikiUpError("WWW_DIR not a symlink", 1)

    src_images = src / "images"
    dst_images = dst / "images"
    dst_images_1st = dst / "images.1st"

    if not src_images.is_dir():
        logger.error("Already moved: %s", src_images)
        _print_undo([f"mv {_q(dst_images)} {_q(src_images)}" if dst_images.exists() else ""])
        raise WikiUpError("Images already moved", 2)

    if dst_images.is_dir():
        if dst_images_1st.exists():
            logger.error("Already backed up stock images: %s", dst_images_1st)
            _print_undo([f"mv {_q(dst_images_1st)} {_q(dst_images)}"])
            raise WikiUpError("Stock images already backed up", 3)
        else:
            cmd = f"mv {_q(dst_images)} {_q(dst_images_1st)}"
            undo = f"mv {_q(dst_images_1st)} {_q(dst_images)}"
            if dry_run:
                print(cmd, file=out)
            else:
                log("Moving stock images: %s to %s" % (dst_images, dst_images_1st))
                shutil.move(str(dst_images), str(dst_images_1st))
                undo_commands.append(undo)
    else:
        logger.error("No stock images directory: %s", dst_images)
        _print_undo([])
        raise WikiUpError("No stock images", 4)

    # Move user images
    cmd = f"mv {_q(src_images)} {_q(dst)}/"
    undo = f"mv {_q(dst / 'images')} {_q(src_images)}"
    if dry_run:
        print(cmd, file=out)
    else:
        log("Moving user images: %s to %s/" % (src_images, dst))
        shutil.move(str(src_images), str(dst))
        undo_commands.append(undo)

    # Handle LocalSettings.php
    dst_local = dst / "LocalSettings.php"
    dst_local_1st = dst / "LocalSettings.php.1st"
    src_local = src / "LocalSettings.php"

    if dst_local.exists():
        if dst_local_1st.exists():
            logger.error("Backup already exists: %s", dst_local_1st)
            _print_undo([f"mv {_q(dst_local_1st)} {_q(dst_local)}"])
            raise WikiUpError("LocalSettings backup exists", 5)
        else:
            cmd = f"cp -a {_q(dst_local)} {_q(dst_local_1st)}"
            undo = f"mv {_q(dst_local_1st)} {_q(dst_local)}"
            if dry_run:
                print(cmd, file=out)
            else:
                log("Backing up stock LocalSettings.php to %s" % dst_local_1st)
                shutil.copy2(str(dst_local), str(dst_local_1st))
                undo_commands.append(undo)
    else:
        logger.error("No stock LocalSettings.php: %s", dst_local)
        _print_undo(undo_commands[::-1])
        raise WikiUpError("No stock LocalSettings.php", 6)

    if src_local.exists():
        cmd = f"cp -a {_q(src_local)} {_q(dst_local)}"
        undo = f"rm -f {_q(dst_local)} && mv {_q(dst_local_1st)} {_q(dst_local)}"
        if dry_run:
            print(cmd, file=out)
        else:
            log("Copying LocalSettings.php to new version")
            shutil.copy2(str(src_local), str(dst_local))
            undo_commands.append(undo)
    else:
        logger.warning("No %s found to copy", src_local)

    # === EXTENSIONS HANDLING ===
    if dry_run:
        print("# Checking extensions...", file=out)
    else:
        log("Checking extensions...")
    ext_total, ext_new = _handle_component(
        src / "extensions",
        dst / "extensions",
        "extensions",
        dry_run,
        out,
        logger,
        undo_commands,
    )
    if dry_run:
        print("# Processed %d, would copy %d new." % (ext_total, ext_new), file=out)
    else:
        log("Processed %d, copied %d new." % (ext_total, ext_new))

    # === SKINS HANDLING ===
    if dry_run:
        print("# Checking skins...", file=out)
    else:
        log("Checking skins...")
    skin_total, skin_new = _handle_component(
        src / "skins",
        dst / "skins",
        "skins",
        dry_run,
        out,
        logger,
        undo_commands,
    )
    if dry_run:
        print("# Processed %d, would copy %d new." % (skin_total, skin_new), file=out)
    else:
        log("Processed %d, copied %d new." % (skin_total, skin_new))

    # Update symlink
    old_link = None
    if www_dir.exists():
        try:
            old_link = www_dir.readlink()
        except Exception:
            pass
        cmd = f"rm -f {_q(www_dir)}"
        undo = f"ln -s {_q(old_link)} {_q(www_dir)}" if old_link else ""
        if dry_run:
            print(cmd, file=out)
        else:
            log("Removing existing symlink: %s" % www_dir)
            try:
                www_dir.unlink()
                if undo:
                    undo_commands.append(undo)
            except OSError as e:
                logger.error("Failed to remove %s: %s", www_dir, e)
                _print_undo(undo_commands[::-1])
                raise WikiUpError("Failed to remove symlink", 7)

    cmd = f"ln -s {_q(dst)} {_q(www_dir)}"
    undo = f"rm -f {_q(www_dir)} && ln -s {_q(old_link)} {_q(www_dir)}" if old_link else f"rm -f {_q(www_dir)}"
    if dry_run:
        print(cmd, file=out)
    else:
        log("Creating symlink: %s to %s" % (www_dir, dst))
        try:
            www_dir.symlink_to(dst)
            undo_commands.append(undo)
        except OSError as e:
            logger.error("Failed to create symlink %s to %s: %s", www_dir, dst, e)
            _print_undo(undo_commands[::-1])
            raise WikiUpError("Failed to create symlink", 7)

    # Final instructions
    instructions = [
        "",
        "# If you have set a custom $wgUploadDirectory (default is false),",
        "# you must move it from %s to %s manually now." % (src, dst),
        "#",
        "# After you have transferred any custom upload directory",
        "# ($wgUploadDirectory), deleted file archives, and any custom skins,",
        "# run the database upgrade script with the correct PHP version:",
        "#",
        "#   cd maintenance",
        "#   php7.3 update.php",
        "#",
        "# Extensions and skins usually need to be upgraded at the same time as the MediaWiki core.",
    ]
    for line in instructions:
        if dry_run:
            print(line, file=out)
        else:
            log(line.lstrip("# ").strip() or "")

    if dry_run:
        print("\n# [DRY RUN] Script generated successfully.", file=out)


def main():
    """Parse arguments and run upgrade."""
    # Configure logger
    logger = get_logger()
    handler = logging.StreamHandler(sys.stderr)
    formatter = logging.Formatter("%(levelname)s: %(message)s")
    handler.setFormatter(formatter)
    logger.addHandler(handler)
    logger.setLevel(logging.INFO)

    parser = argparse.ArgumentParser(
        description=(
            "Upgrade MediaWiki by moving images and LocalSettings.php from "
            "source to destination, and updating the WWW_DIR symlink."
        ),
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )
    parser.add_argument("src", help="Source MediaWiki directory (current version)")
    parser.add_argument("dst", help="Destination MediaWiki directory (new version)")
    parser.add_argument(
        "--dry-run",
        action="store_true",
        help="Output bash script to stdout instead of performing actions",
    )

    args = parser.parse_args()

    src = Path(args.src).resolve()
    dst = Path(args.dst).resolve()
    www_dir = Path(os.getenv("WWW_DIR", "public_html")).resolve()

    if args.dry_run:
        print("#!/bin/bash")
        print("# Generated by wikiup --dry-run")
        print("# Run this script to perform the upgrade")
        print()

    try:
        perform_wiki_upgrade(src, dst, www_dir, dry_run=args.dry_run)
        return 0
    except WikiUpError as e:
        logger.error("%s", e)
        return e.exit_code


if __name__ == "__main__":
    sys.exit(main())
